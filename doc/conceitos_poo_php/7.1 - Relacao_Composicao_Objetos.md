## O que √© composi√ß√£o?

Composi√ß√£o √© uma rela√ß√£o estrutural forte do tipo todo-parte, onde:

- Um objeto (todo) √© formado por outros objetos (partes);
- O todo controla completamente o cilco de vida das partes 
- as partes n√£o fazem sentido existir isoladamente
- A destrui√ß√£o do todo implica a destrui√ß√£o das partes

### formalmente: 

Seja A e B dois objetos. Existe composi√ß√£o se:

- B √© parte da estrutura de A;
- A cria, gerencia e destr√≥i B;
- B n√£a possui identidade fora de A.

## Composi√ß√£o N√ÉO √© t√©cnica, √© modelo mental

Isso √© crucial:

- Composi√ß√£o n√£o depende de linguagem

- N√£o depende de private, final ou readonly

- N√£o depende de construtor

Ela depende exclusivamente do significado do dom√≠nio (Domian)

## Crit√©rios cient√≠ficos da composi√ß√£o

Para algo ser composi√ß√£o TODOS estes crit√©rios devem ser verdadeiros:

| Crit√©rio                 | Obrigat√≥rio |
| ------------------------ | ----------- |
| Rela√ß√£o ‚Äú√© parte de‚Äù     | ‚úÖ           |
| Cria√ß√£o interna          | ‚úÖ           |
| Ciclo de vida dependente | ‚úÖ           |
| N√£o compartilh√°vel       | ‚úÖ           |
| Encapsulamento           | ‚úÖ           |

Se um falhar ‚Üí n√£o √© composi√ß√£o

## Para que a composi√ß√£o √© usada

### Modelar estruturas reais do dom√≠nio

Composi√ß√£o serve para representar:

- Estruturas f√≠sicas

- Estruturas l√≥gicas indivis√≠veis

- Estados internos

Exemplos conceituais:

- Pedido ‚Üí Itens

- Relat√≥rio ‚Üí Cabe√ßalho

- Usu√°rio ‚Üí Credenciais

- Conta ‚Üí Extrato

- Sess√£o ‚Üí Tokens
 
## Encapsular invariantes fortes

Composi√ß√£o permite garantir regras que n√£o podem ser quebradas externamente.

Exemplo:

- Um Pedido sempre tem itens v√°lidos

- Um CPF sempre est√° validado

- Um Per√≠odo sempre tem in√≠cio < fim

## Reduzir estados inv√°lidos

Quanto mais composi√ß√£o:

- Menos setters

- Menos estados intermedi√°rios

- Menos objetos inv√°lidos circulando

- Isso √© engenharia defensiva

## Exemplo de Composi√ß√£o em PHP

```php
final class ItemPedido
{
    public function __construct(
        private string $produto,
        private int $quantidade
    ) {
        if ($quantidade <= 0) {
            throw new InvalidArgumentException();
        }
    }
}

final class Pedido
{
    /** @var ItemPedido[] */
    private array $itens = [];

    public function adicionarItem(string $produto, int $quantidade): void
    {
        $this->itens[] = new ItemPedido($produto, $quantidade);
    }
}
```

### An√°lise cient√≠fica

- Pedido cria ItemPedido

- ItemPedido n√£o √© exposto para fora

- N√£o existe setter

- N√£o existe inje√ß√£o

- Rela√ß√£o forte, fechada

üëâ Composi√ß√£o pura

## Composi√ß√£o ‚â† ‚Äúter um objeto como atributo‚Äù

Isto N√ÉO  √© composi√ß√£o: 

```php
class Pedido
{
    public function __construct(
        private ItemPedido $item
    ) {}
}
```

Por qu√™?

- O item foi criado fora

- Pode ser reutilizado

- Ciclo de vida independente

üëâ Associa√ß√£o obrigat√≥ria, n√£o composi√ß√£o.

## Composi√ß√£o e imutabilidade  

Composi√ß√£o funciona melhor com obetos imut√°veis:

```php
final class Periodo
{
    public function __construct(
        private DateTimeImmutable $inicio,
        private DateTimeImmutable $fim
    ) {
        if ($inicio >= $fim) {
            throw new DomainException();
        }
    }
}

final class Reserva
{
    public function __construct(
        private Periodo $periodo
    ) {}
}
```

Mesmo aqui:

Periodo √© criado fora ‚Üí associa√ß√£o

S√≥ vira composi√ß√£o se Reserva criar o Periodo

## Regra de ouro definitiva

Antes de usar composi√ß√£o, responda:

- Isso √© parte do outro?

- Pode existir sozinho?

- Pode ser compartilhado?

- Quem cria?

- Quem destr√≥i?

Se todas as respostas apontam para depend√™ncia total ‚Üí composi√ß√£o.